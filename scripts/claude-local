#!/bin/bash
# claude-local: Launch Claude Code with Pensieve local server
#
# Usage: claude-local [additional claude options]
# Example: claude-local --continue
# Example: claude-local "write me a hello world function"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOCAL_SETTINGS="$SCRIPT_DIR/settings-local.json"
SERVER_SCRIPT="$SCRIPT_DIR/pensieve-server"

# Check if server is running, start if needed
if ! curl -s http://127.0.0.1:7777/health > /dev/null 2>&1; then
    echo "🔍 Pensieve server not detected on port 7777"

    if [ -x "$SERVER_SCRIPT" ]; then
        echo "🚀 Starting Pensieve server automatically..."
        "$SERVER_SCRIPT" start
        echo ""

        # Wait for server to be ready (max 10 seconds)
        for i in {1..10}; do
            if curl -s http://127.0.0.1:7777/health > /dev/null 2>&1; then
                break
            fi
            sleep 1
        done
    else
        echo "⚠️  WARNING: Server not running and auto-start script not found"
        echo "💡 Start manually: $SERVER_SCRIPT start"
        echo ""
    fi
fi

echo "🚀 Launching Claude Code with LOCAL Pensieve server (127.0.0.1:7777)"
echo "📝 Using settings: $LOCAL_SETTINGS"
echo ""

# Launch Claude Code with local settings override
claude --settings "$LOCAL_SETTINGS" "$@"
