#!/bin/bash
# claude-cloud - Launch Claude Code with Anthropic cloud API
# Smart wrapper that switches configuration automatically

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

CLAUDE_DIR="$HOME/.claude"
SETTINGS_FILE="$CLAUDE_DIR/settings.json"
CLOUD_BACKUP="$CLAUDE_DIR/settings.json.cloud"

# ============================================================================
# Check authentication
# ============================================================================

if [ ! -f "$SETTINGS_FILE" ]; then
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${YELLOW}  ⚠️  Claude Code not logged in${NC}"
    echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "Please login to Claude Code first:"
    echo ""
    echo "  1. Run: ${CYAN}claude${NC}"
    echo "  2. Complete authentication"
    echo "  3. Type: ${CYAN}exit${NC}"
    echo "  4. Try ${CYAN}claude-cloud${NC} again"
    echo ""
    exit 1
fi

# ============================================================================
# Restore cloud configuration
# ============================================================================

# Preserve alwaysThinkingEnabled if it exists
ALWAYS_THINKING=$(grep -o '"alwaysThinkingEnabled"[[:space:]]*:[[:space:]]*[^,}]*' "$SETTINGS_FILE" 2>/dev/null | grep -o 'true\|false' || echo "true")

if [ -f "$CLOUD_BACKUP" ]; then
    # Use backed up cloud config
    cp "$CLOUD_BACKUP" "$SETTINGS_FILE"

    # Update alwaysThinkingEnabled if needed
    if [ "$ALWAYS_THINKING" != "true" ] && grep -q "alwaysThinkingEnabled" "$SETTINGS_FILE"; then
        sed -i.tmp "s/\"alwaysThinkingEnabled\"[[:space:]]*:[[:space:]]*true/\"alwaysThinkingEnabled\": $ALWAYS_THINKING/" "$SETTINGS_FILE"
        rm -f "$SETTINGS_FILE.tmp"
    fi
else
    # Create minimal cloud config (removes local overrides)
    cat > "$SETTINGS_FILE" << EOF
{
  "alwaysThinkingEnabled": $ALWAYS_THINKING
}
EOF
fi

# ============================================================================
# Launch Claude
# ============================================================================

echo -e "${GREEN}☁️  Launching Claude Code with CLOUD API${NC}"
echo -e "${CYAN}   Endpoint: https://api.anthropic.com${NC}"
echo ""

# Launch Claude with any additional arguments
exec claude "$@"
