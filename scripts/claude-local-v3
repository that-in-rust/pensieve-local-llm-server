#!/bin/bash
# claude-local - Launch Claude Code with Pensieve local server
# Smart wrapper that handles everything automatically

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

CLAUDE_DIR="$HOME/.claude"
SETTINGS_FILE="$CLAUDE_DIR/settings.json"

# Resolve script location (handles symlinks)
if [ -L "${BASH_SOURCE[0]}" ]; then
    SCRIPT_LINK=$(readlink "${BASH_SOURCE[0]}")
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_LINK")" && pwd)"
else
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
fi

# ============================================================================
# Check authentication
# ============================================================================

if [ ! -f "$SETTINGS_FILE" ]; then
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}  âš ï¸  Claude Code not logged in${NC}"
    echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "Please login to Claude Code first:"
    echo ""
    echo "  1. Run: ${CYAN}claude${NC}"
    echo "  2. Complete authentication"
    echo "  3. Type: ${CYAN}exit${NC}"
    echo "  4. Try ${CYAN}claude-local${NC} again"
    echo ""
    exit 1
fi

# ============================================================================
# Start server if needed
# ============================================================================

if ! curl -s http://127.0.0.1:7777/health > /dev/null 2>&1; then
    echo -e "${CYAN}ðŸ” Starting Pensieve server...${NC}"

    if command -v pensieve-server &> /dev/null; then
        pensieve-server start
    elif [ -x "$SCRIPT_DIR/pensieve-server" ]; then
        "$SCRIPT_DIR/pensieve-server" start
    else
        echo -e "${YELLOW}âš ï¸  Server not running and pensieve-server command not found${NC}"
        echo ""
        echo "Start manually:"
        echo "  ${CYAN}./target/debug/pensieve start --model /path/to/model.safetensors${NC}"
        echo ""
        exit 1
    fi

    # Wait for server
    echo -n "Waiting for server..."
    for i in {1..15}; do
        if curl -s http://127.0.0.1:7777/health > /dev/null 2>&1; then
            echo " ${GREEN}ready!${NC}"
            break
        fi
        sleep 1
        echo -n "."
    done
    echo ""
fi

# ============================================================================
# Configure settings for local server
# ============================================================================

# Preserve alwaysThinkingEnabled if it exists
ALWAYS_THINKING=$(grep -o '"alwaysThinkingEnabled"[[:space:]]*:[[:space:]]*[^,}]*' "$SETTINGS_FILE" 2>/dev/null | grep -o 'true\|false' || echo "true")

# Create local config
cat > "$SETTINGS_FILE" << EOF
{
  "env": {
    "ANTHROPIC_API_KEY": "test-api-key-12345",
    "ANTHROPIC_BASE_URL": "http://127.0.0.1:7777"
  },
  "alwaysThinkingEnabled": $ALWAYS_THINKING
}
EOF

# ============================================================================
# Launch Claude
# ============================================================================

echo -e "${GREEN}ðŸš€ Launching Claude Code with LOCAL Pensieve server${NC}"
echo -e "${CYAN}   Endpoint: http://127.0.0.1:7777${NC}"
echo ""

# Launch Claude with any additional arguments
exec claude "$@"
