#!/bin/bash
#
# Pensieve Smart Launcher
# Handles setup, model download, server lifecycle, and Claude launching.
#

set -e

# --- Configuration ---
REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
MODEL_DIR="$REPO_ROOT/models/Phi-3-mini-128k-instruct-4bit"
MODEL_REPO="mlx-community/Phi-3-mini-128k-instruct-4bit"
SERVER_PORT=8765
SERVER_HOST="127.0.0.1"
PYTHON_CMD="python3"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log() { echo -e "${BLUE}[Pensieve]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# --- Checks ---

# 1. Check Platform
if [[ "$(uname)" != "Darwin" ]] || [[ "$(uname -m)" != "arm64" ]]; then
    error "Pensieve requires macOS with Apple Silicon (ARM64)."
fi

# 2. Check Python
if ! command -v $PYTHON_CMD &> /dev/null; then
    error "Python 3 not found. Please install Python 3.9+."
fi

# 3. Check Dependencies (Lazy Check)
if ! $PYTHON_CMD -c "import mlx_lm" &> /dev/null; then
    log "Installing dependencies..."
    pip3 install -r "$REPO_ROOT/python_bridge/requirements.txt" huggingface_hub > /dev/null
    success "Dependencies installed."
fi

# 4. Check Model
if [[ ! -f "$MODEL_DIR/model.safetensors" ]]; then
    log "Model not found. Downloading Phi-3 (this happens once)..."
    mkdir -p "$MODEL_DIR"
    $PYTHON_CMD -m huggingface_hub.cli download "$MODEL_REPO" --local-dir "$MODEL_DIR"
    success "Model downloaded."
else
    # Quick check to ensure it's not empty/corrupt
    if [[ $(find "$MODEL_DIR" -name "*.safetensors" -size +1G | wc -l) -eq 0 ]]; then
        warn "Model file seems too small. Re-downloading..."
        $PYTHON_CMD -m huggingface_hub.cli download "$MODEL_REPO" --local-dir "$MODEL_DIR"
    fi
fi

# 5. Check Server Status & Start if Needed
SERVER_URL="http://$SERVER_HOST:$SERVER_PORT/health"
if curl -s -f "$SERVER_URL" > /dev/null 2>&1; then
    success "Server is already running."
else
    log "Starting server in background..."
    "$REPO_ROOT/scripts/start-mlx-server.sh" > "$REPO_ROOT/server.log" 2>&1 &
    SERVER_PID=$!
    
    # Wait for health check (max 30s)
    log "Waiting for server to initialize..."
    attempts=0
    while ! curl -s -f "$SERVER_URL" > /dev/null 2>&1; do
        sleep 1
        attempts=$((attempts + 1))
        if [[ $attempts -gt 30 ]]; then
            error "Server failed to start. Check $REPO_ROOT/server.log"
        fi
    done
    success "Server started (PID $SERVER_PID)."
fi

# 6. Launch Claude
log "Launching Claude Code..."
echo "----------------------------------------"

# Export session variables
export ANTHROPIC_BASE_URL="http://$SERVER_HOST:$SERVER_PORT"
export ANTHROPIC_API_KEY="pensieve-local-token"

# Check if claude exists
if command -v claude &> /dev/null; then
    exec claude "$@"
else
    error "'claude' command not found. Install with: npm install -g @anthropic-ai/claude-code"
fi
